<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KeyNoteLive</title>

    <link rel="stylesheet" href="vendors/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="vendors/font-awesome/css/font-awesome.min.css">

    <style>
      p {
        text-indent: 30px;
      }
      .like {
        margin-left: 5px;
        margin-right: 10px;
      }
      .dislike {
        margin-left: 5px;
      }
      hr {
        margin-top: 50px;
      }
      like-container, dislike-container {
        cursor: pointer;
      }
    </style>

</head>
<body>

<div style="margin-top: 100px;" class="well col-sm-12 col-md-10 col-lg-8 col-md-offset-1 col-lg-offset-2" id="postFeed"></div>

<script src="vendors/jquery/jquery-1.11.1.min.js"></script>
<script src="vendors/bootstrap/js/bootstrap.min.js"></script>
<script src="vendors/socket.io/socket.io.js"></script>

<script>

  var socket;
	(function() {
    //Populate page with cache content.

    socket = io('http://localhost');

    //Add event listeners
    socket.on('post', onPost);

    socket.on('like', function(id) {
      //increment the like counter of the like element identified by 'id'.
      $('#'+id).val();
    });
    socket.on('dislike', function(id) {
      //increment the dislike counter of the dislike element identified by 'id'.
      $('#'+id).val();
    });
    socket.on('update', function() {

    });
    socket.on('delete', function() {

    });

    var latestCachedKeynote = null;
    //Fetch the latest cached point of the keynote
    //Send it to the server.
    socket.emit('ready', latestCachedKeynote);
	})();

  function onPost(data) {
    //Populate keynote feed with post data

    //Push the Keynote object on the feed.
    $('#postFeed').prepend('<div id="' + data._id + '"> \
        <h4><b>' + fancyTime(data.timestamp) + '</b> par ' + data.author + ' </h4> \
        <p>' + data.msg + '</p> \
        <div class="pull-right"> \
        <span class="like-container"><i class="fa fa-thumbs-o-up"></i><span class="like">' + data.like + '</span></span> \
        <span class="dislike-container"><i class="fa fa-thumbs-o-down"></i><span class="dislike">' + data.dislike + '</span> </span> \
        </div> \
        <hr> \
      </div>');

      //Like button click handler
      $('#' + data._id + ' span.like-container ').click(function() {
        //Incrementing local counter
        var e = $(this).find('span');
        e.text(parseInt(e.text()) + 1);

        //Sending the like event to the server
        socket.emit('like', data._id);
      });

      //Like button click handler
      $('#' + data._id + ' span.dislike-container ').click(function() {
        //Incrementing local counter
        var e = $(this).find('span');
        e.text(parseInt(e.text()) + 1);

        //Sending the like event to the server
        socket.emit('dislike', data._id);
      });
    //Store it in the local cache.
  }

  //Utility functions
  function pad(n){return n<10 ? '0'+n : n}

  function fancyTime(timestamp)
  {
    var nameDays = new Array("dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi") ;
    var nameMonth = new Array("janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre") ;

    var actualDate = new Date();
    var postDate = new Date(timestamp);
    var timeDiff = Math.round((actualDate - postDate)/1000);

    if (timeDiff < 86400)
    {
      if (timeDiff >= 60 && timeDiff < 120)
        return "il y a environ une minute";
      else if (timeDiff >= 60 && timeDiff < 3600)
        return "il y a " + Math.floor(timeDiff/60) + " minutes";
      else if (timeDiff >= 3600 && timeDiff < 7200)
        return "il y a environ une heure";
      else if (timeDiff >= 3600)
        return "il y a " + Math.floor(timeDiff/3600) + " heures";
      else
        return "il y a moins d'une minute";
    }
    else if(timeDiff < 172800)
      return "hier à " + pad(postDate.getHours()) + ":" + pad(postDate.getMinutes());
    else if(postDate.getWeek() == actualDate.getWeek())
      return nameDays[postDate.getDay()] + " à " + pad(postDate.getHours()) + ":" + pad(postDate.getMinutes());
    else
      return postDate.getDate() + " " + nameMonth[postDate.getMonth()] + ", à " + pad(postDate.getHours()) + ":" + pad(postDate.getMinutes());
  }

</script>

</body>
</html>
